# Домашнее задание к занятию 5. «Практическое применение Docker»

### Инструкция к выполнению

1. Для выполнения заданий обязательно ознакомьтесь с [инструкцией](https://github.com/netology-code/devops-materials/blob/master/cloudwork.MD) по экономии облачных ресурсов. Это нужно, чтобы не расходовать средства, полученные в результате использования промокода.
3. **Своё решение к задачам оформите в вашем GitHub репозитории.**
4. В личном кабинете отправьте на проверку ссылку на .md-файл в вашем репозитории.
5. Сопроводите ответ необходимыми скриншотами.

---
## Примечание: Ознакомьтесь со схемой виртуального стенда [по ссылке](https://github.com/netology-code/shvirtd-example-python/blob/main/schema.pdf)

---

## Задача 0
1. Убедитесь что у вас НЕ(!) установлен ```docker-compose```, для этого получите следующую ошибку от команды ```docker-compose --version```
```
Command 'docker-compose' not found, but can be installed with:

sudo snap install docker          # version 24.0.5, or
sudo apt  install docker-compose  # version 1.25.0-1

See 'snap info docker' for additional versions.
```
В случае наличия установленного в системе ```docker-compose``` - удалите его.  
2. Убедитесь что у вас УСТАНОВЛЕН ```docker compose```(без тире) версии не менее v2.24.X, для это выполните команду ```docker compose version```  
###  **Своё решение к задачам оформите в вашем GitHub репозитории!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!**

---
### Ответ
<img width="1052" height="210" alt="image" src="https://github.com/user-attachments/assets/f8970c8a-0bce-4f4d-b077-ebfd04ed6c51" />

---

## Задача 1
1. Сделайте в своем GitHub пространстве fork [репозитория](https://github.com/netology-code/shvirtd-example-python).

2. Создайте файл ```Dockerfile.python``` на основе существующего `Dockerfile`:
   - Используйте базовый образ ```python:3.12-slim```
   - Обязательно используйте конструкцию ```COPY . .``` в Dockerfile
   - Создайте `.dockerignore` файл для исключения ненужных файлов
   - Используйте ```CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5000"]``` для запуска
   - Протестируйте корректность сборки
2.1 (Необязательная часть, *) Используйте multistage сборку вместо single stage.
3. (Необязательная часть, *) Изучите инструкцию в проекте и запустите web-приложение без использования docker, с помощью venv. (Mysql БД можно запустить в docker run).
4. (Необязательная часть, *) Изучите код приложения и добавьте управление названием таблицы через ENV переменную.
---
### ВНИМАНИЕ!
!!! В процессе последующего выполнения ДЗ НЕ изменяйте содержимое файлов в fork-репозитории! Ваша задача ДОБАВИТЬ 5 файлов: ```Dockerfile.python```, ```compose.yaml```, ```.gitignore```, ```.dockerignore```,```bash-скрипт```. Если вам понадобилось внести иные изменения в проект - вы что-то делаете неверно!

---
### Ответ
fork не стал делать, перенес к себе в проект файлы "как есть". Дальше работал с этим каталогом - https://github.com/LuckyVl/devops/tree/main/17-04.  
Вместо Dockerfile.python использую Dockerfile.python.multistage.  
Dockerfile.python - есть в проекте и содержит одноэтапную сборку.  
Dockerfile.python.multistage - есть в проекте и содержит многоэтапную сборку.  
---

## Задача 2 (*)
1. Создайте в yandex cloud container registry с именем "test" с помощью "yc tool" . [Инструкция](https://cloud.yandex.ru/ru/docs/container-registry/quickstart/?from=int-console-help)
2. Настройте аутентификацию вашего локального docker в yandex container registry.
3. Соберите и залейте в него образ с python приложением из задания №1.
4. Просканируйте образ на уязвимости.
5. В качестве ответа приложите отчет сканирования.

---
### Ответ
<img width="1078" height="366" alt="image" src="https://github.com/user-attachments/assets/3afc6ae4-f1d0-4297-b86e-81eb6264d8f7" />
<img width="1292" height="1124" alt="image" src="https://github.com/user-attachments/assets/5a25e638-8bac-4c58-9401-680cdac9b7a0" />

---

## Задача 3
1. Изучите файл "proxy.yaml"
2. Создайте в репозитории с проектом файл ```compose.yaml```. С помощью директивы "include" подключите к нему файл "proxy.yaml".
3. Опишите в файле ```compose.yaml``` следующие сервисы: 

- ```web```. Образ приложения должен ИЛИ собираться при запуске compose из файла ```Dockerfile.python``` ИЛИ скачиваться из yandex cloud container registry(из задание №2 со *). Контейнер должен работать в bridge-сети с названием ```backend``` и иметь фиксированный ipv4-адрес ```172.20.0.5```. Сервис должен всегда перезапускаться в случае ошибок.
Передайте необходимые ENV-переменные для подключения к Mysql базе данных по сетевому имени сервиса ```web``` 

- ```db```. image=mysql:8. Контейнер должен работать в bridge-сети с названием ```backend``` и иметь фиксированный ipv4-адрес ```172.20.0.10```. Явно перезапуск сервиса в случае ошибок. Передайте необходимые ENV-переменные для создания: пароля root пользователя, создания базы данных, пользователя и пароля для web-приложения.Обязательно используйте уже существующий .env file для назначения секретных ENV-переменных!

2. Запустите проект локально с помощью docker compose , добейтесь его стабильной работы: команда ```curl -L http://127.0.0.1:8090``` должна возвращать в качестве ответа время и локальный IP-адрес. Если сервисы не стартуют воспользуйтесь командами: ```docker ps -a ``` и ```docker logs <container_name>``` . Если вместо IP-адреса вы получаете информационную ошибку --убедитесь, что вы шлете запрос на порт ```8090```, а не 5000.

5. Подключитесь к БД mysql с помощью команды ```docker exec -ti <имя_контейнера> mysql -uroot -p<пароль root-пользователя>```(обратите внимание что между ключем -u и логином root нет пробела. это важно!!! тоже самое с паролем) . Введите последовательно команды (не забываем в конце символ ; ): ```show databases; use <имя вашей базы данных(по-умолчанию virtd, как это указано в .env)>; show tables; SELECT * from requests LIMIT 10;```. Примечание: таблица в БД создается после первого поступившего запроса к приложению.

6. Остановите проект. В качестве ответа приложите скриншот sql-запроса.

---
### Ответ
<img width="1047" height="638" alt="image" src="https://github.com/user-attachments/assets/d4feed1f-cfc3-428e-9536-ffbef746b44e" />

---

## Задача 4
1. Запустите в Yandex Cloud ВМ (вам хватит 2 Гб Ram).
2. Подключитесь к Вм по ssh и установите docker.
3. Напишите bash-скрипт, который скачает ваш fork-репозиторий в каталог /opt и запустит проект целиком.
4. Зайдите на сайт проверки http подключений, например(или аналогичный): ```https://check-host.net/check-http``` и запустите проверку вашего сервиса ```http://<внешний_IP-адрес_вашей_ВМ>:8090```. Таким образом трафик будет направлен в ingress-proxy. Трафик должен пройти через цепочки: Пользователь → Internet → Nginx → HAProxy → FastAPI(запись в БД) → HAProxy → Nginx → Internet → Пользователь
5. (Необязательная часть) Дополнительно настройте remote ssh context к вашему серверу. Отобразите список контекстов и результат удаленного выполнения ```docker ps -a```
6. Повторите SQL-запрос на сервере и приложите скриншот и ссылку на fork.

---
### Ответ
**https://github.com/LuckyVl/devops/tree/main/17-04**  
<img width="1823" height="438" alt="image" src="https://github.com/user-attachments/assets/511fdfb8-14e6-4171-88e2-f9d7e4c82eec" />

---

## Задача 5 (*)
1. Напишите и задеплойте на вашу облачную ВМ bash скрипт, который произведет резервное копирование БД mysql в директорию "/opt/backup" с помощью запуска в сети "backend" контейнера из образа ```schnitzler/mysqldump``` при помощи ```docker run ...``` команды. Подсказка: "документация образа."
2. Протестируйте ручной запуск
3. Настройте выполнение скрипта раз в 1 минуту через cron, crontab или systemctl timer. Придумайте способ не светить логин/пароль в git!!
4. Предоставьте скрипт, cron-task и скриншот с несколькими резервными копиями в "/opt/backup"

---
### Ответ
https://github.com/LuckyVl/devops/blob/main/17-04/backup-mysql.sh
<img width="723" height="55" alt="image" src="https://github.com/user-attachments/assets/a4b64c3f-9bec-44db-b91c-e22e239c86d3" />
<img width="841" height="268" alt="image" src="https://github.com/user-attachments/assets/f75e63fe-8f66-4667-85c5-1b19b598e3e0" />
<img width="1041" height="216" alt="image" src="https://github.com/user-attachments/assets/46e31844-707f-4680-9b73-2a0a6ad2c94e" />

---

## Задача 6
Скачайте docker образ ```hashicorp/terraform:latest``` и скопируйте бинарный файл ```/bin/terraform``` на свою локальную машину, используя dive и docker save.
Предоставьте скриншоты  действий .
---
### Ответ
<img width="1731" height="1039" alt="image" src="https://github.com/user-attachments/assets/0e29b644-4ae9-4194-9370-822932b8f2f4" />
<img width="1543" height="230" alt="image" src="https://github.com/user-attachments/assets/b4927291-97dc-4fa2-a25a-3c29d67c4e79" />
<img width="1041" height="216" alt="image" src="https://github.com/user-attachments/assets/fea3f16c-aa1e-414d-81c2-2a446d089437" />

---

## Задача 6.1
Добейтесь аналогичного результата, используя docker cp.  
Предоставьте скриншоты  действий .

---
### Ответ
<img width="1051" height="235" alt="image" src="https://github.com/user-attachments/assets/b8f722de-e614-4198-857b-2fa73b08d7c1" />
<img width="1076" height="245" alt="image" src="https://github.com/user-attachments/assets/5533ae9a-b29d-48b9-8e04-cd27021ff081" />

---

## Задача 6.2 (**)
Предложите способ извлечь файл из контейнера, используя только команду docker build и любой Dockerfile.  
Предоставьте скриншоты  действий .

---
### Ответ
<img width="951" height="507" alt="image" src="https://github.com/user-attachments/assets/28966336-149e-4b43-8934-fb66360a3387" />
<img width="817" height="247" alt="image" src="https://github.com/user-attachments/assets/d138c135-81d9-4d17-88b2-001dec00bdd8" />
<img width="1164" height="187" alt="image" src="https://github.com/user-attachments/assets/c34ea939-df3f-4486-bab8-7543972a58ef" />
<img width="2410" height="770" alt="image" src="https://github.com/user-attachments/assets/d2293586-ad9f-4e88-9903-02b704147307" />

---

## Задача 7 (***)
Запустите ваше python-приложение с помощью runC, не используя docker или containerd.  
Предоставьте скриншоты  действий .

---
### Ответ
<img width="1615" height="563" alt="image" src="https://github.com/user-attachments/assets/4b99aa0b-f147-405b-b178-9b073bd22a7a" />
<img width="1399" height="264" alt="image" src="https://github.com/user-attachments/assets/944b07dd-6a9c-4f6e-b296-0724e1975c7d" />
<img width="1734" height="746" alt="image" src="https://github.com/user-attachments/assets/1c293bdf-8e6c-4c2d-95af-a6a7484e8297" />

---


