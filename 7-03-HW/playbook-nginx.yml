---
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –Ω–∞ Ubuntu —á–µ—Ä–µ–∑ jump host
  hosts: webservers
  become: yes
  become_user: root

  vars:
    nginx_config_path: /etc/nginx/nginx.conf
    web_root: /var/www/html

  pre_tasks:
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Nginx
      ansible.builtin.command: dpkg -l nginx
      ignore_errors: yes
      changed_when: false
      register: nginx_installed

    - name: –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Nginx
      ansible.builtin.debug:
        msg: "‚úÖ Nginx —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {{ ansible_hostname }}"
      when: nginx_installed.rc == 0

    - name: Nginx –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      ansible.builtin.debug:
        msg: "üîß Nginx –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
      when: nginx_installed.rc != 0

    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ /var/www/html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

  tasks:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ nginx.conf
      ansible.builtin.copy:
        src: ./nginx.conf
        dest: "{{ nginx_config_path }}"
        owner: root
        group: root
        mode: '0644'
        backup: yes
      notify: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx

    - name: –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã my.html
      ansible.builtin.template:
        src: templates/my.html.j2
        dest: "{{ web_root }}/my.html"
        owner: www-data
        group: www-data
        mode: '0644'

    - name: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∞–π—Ç Nginx, (–∫–æ–Ω—Ñ–ª–∏–∫—Ç default_server)
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ Nginx
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx
      ansible.builtin.shell: |
        if nginx -t; then
          systemctl reload nginx
          echo "‚úÖ Nginx: –∫–æ–Ω—Ñ–∏–≥ –≤–∞–ª–∏–¥–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω."
        else
          echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!"
          exit 1
        fi
      args:
        executable: /bin/bash