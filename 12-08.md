# Домашнее задание к занятию «Резервное копирование баз данных»

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.**

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы задавайте в разделе «Вопросы по заданию» в личном кабинете.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---
### Ответ
- 1.1. Восстановление данных в полном объёме за предыдущий день  
Полное резервное копирование (full backup) + бинарные логи (binary logs).  
Как работает:  
Ежедневно (например, ночью в 00:00) выполняется полный дамп базы данных с помощью mysqldump или mysqlpump.  
Включены binary logs, которые фиксируют все изменения в базе в реальном времени.  
Восстановление:  
Восстанавливается полный дамп за предыдущий день.  
При необходимости — применяются binary logs до нужного момента (например, до конца суток, если нужно состояние «на конец вчерашнего дня»).  

- 1.2. Восстановление данных за час до предполагаемой поломки  
Полное резервное копирование + непрерывная архивация binary logs (point-in-time recovery).  
Как работает:  
Полный бэкап делается раз в сутки (или раз в несколько часов — в зависимости от нагрузки и RPO).  
Binary logs регулярно архивируются (например, каждые 5–15 минут) на отдельный надёжный носитель.  
При сбое:  
Восстанавливаем последний полный бэкап.  
Применяете все binary log-файлы вплоть до нужного момента — например, до 2025-06-10 14:00:00 (за час до сбоя в 15:00).  
Что нужно для реализации:  
binlog_format = ROW  
log_bin = ON  
binlog_expire_logs_seconds = 172800 (2 дня)  

- 1.3. Моментальное переключение на работающую или восстановленную БД*  
Да, такой кейс возможен — он реализуется с помощью репликации + автоматического переключения (failover).  
Как работает:  
Настроена master-slave репликация  
При отказе основного сервера (master) система автоматически:  
Обнаруживает сбой (через оркестратор - например Orchestrator, MHA, ProxySQL + keepalived)  
Повышает slave до нового master (promote)  
Перенаправляет все подключения клиентов на новый master (через виртуальный IP, DNS)  
Результат:  
Время простоя (RTO) может составлять от нескольких секунд до 1–2 минут  
Потери данных (RPO) — минимальны, если репликация полусинхронная (semisync)  
---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---
### Ответ
- 2.1.
Пример 1: Создание дампа в формате SQL  
```bash
pg_dump -U postgres -h localhost -d mydb > mydb_backup.sql
```
Пример 2: Создание дампа в формате dump (с архивированием)
```bash
pg_dump -U postgres -h localhost -d mydb -F c -f mydb_backup.dump
```
Пример 1: Восстановление дампа в формате SQL (БД mydb_restored должна быть создана заранее)
```bash
psql -U postgres -d mydb_restored -f mydb_backup.sql
```
Пример 2: Восстановление дампа из формата dump
```bash
pg_restore -U postgres -d mydb_restored mydb_backup.dump
```

- 2.1.* Пример bash-скрипта
```bash
#!/bin/bash

# Параметры
DB_NAME="mydb"
DB_USER="postgres"
BACKUP_DIR="/backups/postgres"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_$DATE.dump"

# Создание каталога, если не существует
mkdir -p "$BACKUP_DIR"

# Резервное копирование
pg_dump -U "$DB_USER" -d "$DB_NAME" -F c -f "$BACKUP_FILE"

# Удаление резервных копий старше 7 дней
find "$BACKUP_DIR" -name "${DB_NAME}_*.dump" -mtime +7 -delete

# Логирование
echo "[$(date)] Backup created: $BACKUP_FILE" >> /var/log/pg_backup.log
```
Настройка расписания запуска резервирования
```bash
crontab -e
0 2 * * * /path/to/pg_backup.sh
```
---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*


---
### Ответ
- 3.1.
Полный бэкап (с записью позиции binlog)  
```bash
mysqldump --all-databases --single-transaction --master-data=2 --flush-logs -u root -p > full_backup_$(date +%F).sql
```
Архивация binary logs
```bash
mysqlbinlog --start-datetime="2025-06-10 00:00:00" \
            --stop-datetime="2025-06-11 00:00:00" \
            /var/log/mysql/mysql-bin.000002 > binlog_increment.sql
```
Восстановление из бэкап
```bash
mysql -u root -p < full_backup_2025-06-10.sql
```
Восстановление из binlog
```bash
mysql -u root -p < binlog_increment.sql
```

- 3.1.*
Использование реплики (replica) даёт следующие преимущества по сравнению с классическим резервным копированием:

| Сценарий                    | Резервное копирование                            | Реплика                                        |
|-----------------------------|--------------------------------------------------|------------------------------------------------|
| Время восстановления (RTO)  | Минуты–часы                                      | Секунды                                        |
| Потери данных (RPO)         | До момента последнего бэкапа                     | Почти ноль                                     |
| Нагрузка на основной сервер | Высокая во время бэкапа                          | Нагрузка распределяется                        |
| Доступность на чтение       | Бэкап — это файл, данные недоступны для запросов | Реплика: можно читать данные в реальном времен |
| Тестирование                | Проще                                            | Сложнее                                        |
| Использование               | Нужно развернуть отдельную копию                 | Можно использовать реплику для тестов          |

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.